<p align="center">
  <a href="https://github.com/atlas-foundry/poml-go-sdk/actions/workflows/ci.yml">
    <img src="https://github.com/atlas-foundry/poml-go-sdk/actions/workflows/ci.yml/badge.svg" alt="CI Status" />
  </a>
  <a href="https://codecov.io/gh/atlas-foundry/poml-go-sdk">
    <img src="https://codecov.io/gh/atlas-foundry/poml-go-sdk/branch/main/graph/badge.svg" alt="Coverage" />
  </a>
  <a href="https://github.com/atlas-foundry/poml-go-sdk/releases">
    <img src="https://img.shields.io/github/v/release/atlas-foundry/poml-go-sdk?logo=github&color=4c1" alt="Release" />
  </a>
  <a href="https://pkg.go.dev/github.com/atlas-foundry/poml-go-sdk">
    <img src="https://pkg.go.dev/badge/github.com/atlas-foundry/poml-go-sdk.svg" alt="Go Reference" />
  </a>
  <a href="https://goreportcard.com/report/github.com/atlas-foundry/poml-go-sdk">
    <img src="https://goreportcard.com/badge/github.com/atlas-foundry/poml-go-sdk" alt="Go Report Card" />
  </a>
  <a href="https://microsoft.github.io/poml">
    <img src="https://img.shields.io/badge/POML-Supported-8a2be2.svg?logo=microsoft" alt="POML Supported" />
  </a>
  <a href="https://www.conventionalcommits.org/">
    <img src="https://img.shields.io/badge/Conventional%20Commits-1.0.0-ff69b4.svg" alt="Conventional Commits" />
  </a>
</p>

# poml-go-sdk

**The official Go SDK for [POML](https://microsoft.github.io/poml) â€” Prompt Orchestration Markup Language.**

POML is a structured, spec-driven language for orchestrating AI prompts. It's declarative, expressive, type-safe, and multi-modal â€” making it far easier to maintain than a giant prompt blob. This SDK brings POML's power to Go with a focus on spec compliance, safety, and developer experience.

---

## Getting Started

Install the SDK using Go modules:

```bash
go get github.com/atlas-foundry/poml-go-sdk
```

Run the test suite to verify your installation:

```bash
go test ./...
```

---

## Key Concepts

### Document
The `Document` type represents a parsed POML file. It contains structured sections like `Meta`, `Role`, `Task`, `Input`, messages, and media elements. Documents can be parsed from files, strings, or readers.

### Builder
The `poml.Builder` provides a fluent API for constructing POML documents programmatically (similar to Python's `Prompt` object). Use it to build prompts in code with type safety and validation.

### Convert
The `Convert` function transforms parsed POML documents into various formats for use with different LLM providers:
- `FormatOpenAIChat` â€” OpenAI chat completion format
- `FormatLangChain` â€” LangChain message format
- `FormatMessageDict` â€” Generic message dictionary
- `FormatDict` â€” Full document dictionary
- `FormatPydantic` â€” Pydantic-compatible output

Converters enforce safety rules: `BaseDir` containment (symlink-aware), 10MB default caps for media files (configurable via `MaxImageBytes`/`MaxMediaBytes`), and proper handling of extended tags.

---

## Usage Examples

### Parsing a POML File

```go
package main

import (
    "fmt"
    "github.com/atlas-foundry/poml-go-sdk/poml"
)

func main() {
    // Parse from file
    doc, err := poml.ParseFile("story.poml")
    if err != nil {
        panic(err)
    }

    // Validate the document
    if err := poml.Validate(doc); err != nil {
        panic(err)
    }

    // Access structured fields
    fmt.Println("Role:", doc.Role.Body)
    fmt.Println("Task:", doc.Tasks[0].Body)
}
```

### Using the Builder (Prompt Construction)

```go
package main

import (
    "fmt"
    "github.com/atlas-foundry/poml-go-sdk/poml"
)

func main() {
    // Build a prompt programmatically
    doc := poml.NewBuilder().
        Meta("my-prompt", "1.0.0", "me").
        Role("You are a helpful assistant.").
        Task("Explain quantum computing to a 10-year-old.").
        Human("What is quantum computing?").
        Build()

    // Encode to POML string
    output, err := poml.EncodeWithOptions(doc, poml.EncodeOptions{
        Indent: "  ",
        Header: true,
    })
    if err != nil {
        panic(err)
    }
    fmt.Println(output)
}
```

### Converting to OpenAI Format

```go
package main

import (
    "encoding/json"
    "fmt"
    "github.com/atlas-foundry/poml-go-sdk/poml"
)

func main() {
    doc, err := poml.ParseFile("prompt.poml")
    if err != nil {
        panic(err)
    }

    // Convert to OpenAI chat format with safety options
    result, err := poml.Convert(doc, poml.FormatOpenAIChat, poml.ConvertOptions{
        BaseDir:            "./assets",
        AllowAbsImagePaths: false,
        MaxImageBytes:      10 << 20, // 10MB cap
        MaxMediaBytes:      10 << 20, // 10MB cap for audio/video
    })
    if err != nil {
        panic(err)
    }

    // Use the result with OpenAI
    jsonData, err := json.MarshalIndent(result, "", "  ")
    if err != nil {
        panic(err)
    }
    fmt.Println(string(jsonData))
}
```

---

## Parity & Compliance

This SDK is designed to maintain parity with the **Python reference implementation** and adheres to the official [POML specification](https://microsoft.github.io/poml). Key compliance features:

- âœ… Full spec-aligned parser with round-trip fidelity
- âœ… Support for extended tags: `<hint>`, `<example>`, `<cp>`, `<object>`, `<tool>`
- âœ… Multimedia handling: images, audio, video with proper MIME detection
- âœ… Format converters matching Python SDK outputs (message_dict, dict, openai_chat, langchain, pydantic)
- âœ… Semantic validation for required sections (meta, role, task)
- âœ… Safety features: symlink-aware path containment, configurable size limits

The SDK uses fixtures from the Python SDK and maintains parity through automated tests. See `poml/testdata/examples/` for example POML files with expected outputs.

---

## Repository Documentation

> **Note:** This repository uses POML for all documentation.  
> The only non-POML doc allowed is this `README.mdx` (for GitHub rendering).

Structured documentation files:
- **[README.poml](README.poml)** â€” Full structured README with usage guidance
- **[PLAN.poml](PLAN.poml)** â€” Development roadmap and milestones
- **[AI.LOCK.poml](AI.LOCK.poml)** â€” Automated run timeline and logs
- **[docs/fit_for_purpose.poml](docs/fit_for_purpose.poml)** â€” Validation goals and benchmarks
- **[AGENTS.poml](AGENTS.poml)** â€” Rules and guidelines for automation agents
- **[poml/testdata/examples/](poml/testdata/examples/)** â€” Multimedia examples and parity fixtures

### Contribution Rules

When contributing to this repository:
- **Do not** add markdown/org/mdx files besides `README.mdx`
- Author all docs in POML (`*.poml`) using extended tags (`hint`, `example`, `cp`, `object`, `list`, etc.)
- Keep new instructions in `AGENTS.poml` for discoverability
- Link high-signal docs from this README.mdx

---

## Media & Safety Rules

Converters enforce strict safety rules to prevent accidental file system access and resource exhaustion:

- **BaseDir Containment**: All relative paths are resolved within a specified `BaseDir`. Symlink-aware checks prevent directory traversal attacks.
- **Absolute Path Control**: Absolute image paths are disabled by default (enable via `AllowAbsImagePaths`).
- **Size Limits**: Default 10MB caps for image, audio, and video files. Override via `MaxImageBytes`/`MaxMediaBytes` in `ConvertOptions` (set to `-1` to disable).
- **Format Emission**: Extended tags (`<hint>`, `<example>`, `<cp>`, `<object>`) and multimedia content are properly emitted as user context across all conversion formats.

Example with safety options:

```go
result, err := poml.Convert(doc, poml.FormatOpenAIChat, poml.ConvertOptions{
    BaseDir:            "./assets",
    AllowAbsImagePaths: false,      // Disallow absolute paths
    MaxImageBytes:      5 << 20,    // 5MB image cap
    MaxMediaBytes:      20 << 20,   // 20MB audio/video cap
})
```

---

## Project Structure

```
poml/                          # Core SDK package
  parser.go                    # POML parser (file/string/reader)
  builder.go                   # Fluent API for document construction
  converter.go                 # Format converters (OpenAI, LangChain, etc.)
  renderer.go                  # POML renderer
  testdata/examples/           # Example POML files with golden outputs
docs/                          # Additional documentation (in POML)
tools/                         # Development tools
.github/                       # CI workflows and templates
```

---

## Conventional Commits

This project uses [Conventional Commits](https://www.conventionalcommits.org/) for semantic versioning:

```
feat: add something new âœ¨
fix: squish a bug ðŸ›
docs: improve docs ðŸ“˜
test: add/modify tests ðŸ§ª
chore: misc tasks ðŸ§¹
ci: workflow updates âš™ï¸
refactor: structural changes ðŸ§ 
```

For breaking changes, use `!`:
```
feat!: major API change
```

---

## Contributing

We welcome contributions from everyone! Whether you're:
- New to Go
- New to POML
- New to open source

Your contributions are valued. Open a PR, file an issue, add test cases, or improve documentation. Let's build something wonderful together! âœ¨

---

## License

MIT License â€” see [LICENSE](LICENSE) for details.

---

## Learn More

- **POML Specification**: [https://microsoft.github.io/poml](https://microsoft.github.io/poml)
- **Go Package Documentation**: [pkg.go.dev/github.com/atlas-foundry/poml-go-sdk](https://pkg.go.dev/github.com/atlas-foundry/poml-go-sdk)
- **Python Reference SDK**: [microsoft/poml](https://github.com/microsoft/poml)

If you're thinking "Should I open a PR?" â€” the answer is **YES**. ðŸ’–
