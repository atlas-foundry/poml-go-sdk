name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      - name: Verify formatting
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            gofmt -l .
            exit 1
          fi
      - name: Test with coverage (>=80%)
        run: |
          go test -coverprofile=coverage.out ./...
          python3 - <<'PY'
import subprocess, sys
limit = 80.0
report = subprocess.check_output(["go", "tool", "cover", "-func=coverage.out"], text=True)
total = None
for line in report.splitlines():
    if line.startswith("total:"):
        total = line.split()[-1]
        break
if total is None or not total.endswith("%"):
    sys.exit("failed to parse coverage report:\n" + report)
pct = float(total.rstrip("%"))
if pct < limit:
    sys.exit(f"coverage {pct}% below threshold {limit}%")
print(f"coverage {pct}% (threshold {limit}%)")
PY
