# poml-go-sdk Delivery Plan (Project Management)

Use this as an execution script for GPT-5.1-codex-max with minimal extra reading. Each bullet names files/functions, exact commands, and exit checks. Communicate cross-workstream status only via `AI.LOCK.mdx` (append short, timestamped notes).

## Phase 0 — Unblock & Baseline
- **Fix go.sum**: in repo root `poml-go-sdk`: `/usr/local/go/bin/go mod tidy` (or `go get github.com/niklasfasching/go-org/org@v1.6.6`), commit new `go.sum` entries for `golang.org/x/net/html`/`html/atom`. Exit: `/usr/local/go/bin/go test ./...` passes.
- **Record baseline**: Run `/usr/local/go/bin/go test -cover ./...` capture runtime and coverage percentage into `AI.LOCK.mdx` for later comparison.

## Phase 1 — Security & Robustness Hardening
- **Image path containment**: Edit `poml/converter.go`, function `resolveImagePath`. Steps: `base, _ := filepath.EvalSymlinks(opts.BaseDir)` (handle empty), `candidate := filepath.EvalSymlinks(cleaned)`, compute `rel := filepath.Rel(base, candidate)`, reject if error or `strings.HasPrefix(rel, "..")`. Preserve `AllowAbsImagePaths` behavior. Tests in `poml/converter_test.go`: create `t.TempDir()`, inside create symlink pointing outside (`os.Symlink`). Expect `buildImagePart` error. Also test allowed relative, allowed absolute with `AllowAbsImagePaths: true`.
- **Default image size cap**: In `buildImagePart`/`readFileWithLimit`, add default (e.g., `const defaultMaxImageBytes = 10 << 20`) applied when `opts.MaxImageBytes == 0`. Enforce on data URI? (no; only file reads). Tests: create >limit file (`bytes.Repeat`), expect error; set `MaxImageBytes` above size to allow. Update README note.
- **Tool event validation**: In `Document.Validate` (`poml/parser.go`), build maps: tool-definition names, tool-request IDs. For each tool-response/result/error ensure `ID` exists in requests and `Name` exists in definitions (or allow missing definition? follow Python: must exist). Add table-driven tests in `poml/parser_test.go` for missing/unknown IDs/names (expect `POMLError` with `ErrValidate`) and valid case passes.
- Exit: new tests passing; README/CHANGELOG note limits and safety.

## Phase 2 — Parity Surface Expansion (Python feature match)
- **Tag coverage**: Update `poml/parser.go` structs/enums to include missing Python tags (tool-call variants, schema/runtime attrs, multimedia types). Ensure `decodePoml`/`encodeElement` handle them; extend `Validate`. Add fixtures under `poml/testdata` mirroring Python `examples/*.poml`.
- **Format converters**: In `poml/converter.go`, ensure `FormatMessageDict/Dict/OpenAIChat/LangChain/Pydantic` match Python outputs: tool_calls array shape, response_format payload, runtime merge rules, multimedia parts (image/audio/video) normalized. Add tests beside existing converters to assert exact JSON maps for known fixtures.
- **Builder/tag helpers**: Add builder APIs in new file `poml/builder.go` (or similar) mirroring Python `Prompt` helpers: functions to add meta/role/task/input/doc/style/message/tool-definition/request/response/schema/runtime/image tags fluently. Add unit tests to validate built Document encodes to expected XML.
- **Multimedia**: Extend `Image` or new structs for audio/video if needed; add MIME sniffing (extension map) in `converter.go`. Tests: ingest bytes/base64/file paths for multiple media types; ensure BaseDir rules apply.
- **Tracing hooks**: Add optional tracing package (e.g., `poml/trace.go`) with `SetTrace(TraceSink)` and helpers `TraceArtifact` etc., no-op by default, env gated. Add simple mock sink test.
- Exit: new APIs mirrored; converter outputs match Python fixtures; validation updated.

## Phase 3 — Fixtures, Tests, and CI
- **Port Python fixtures/tests**: Copy Python fixtures into `poml/testdata/examples` with expected outputs (`expects/*.txt/json`). Create Go tests (new file `poml/examples_parity_test.go`) replicating Python `test_basic.py`, `test_poml_formats.py`, `test_examples.py` behavior.
- **Golden tests**: Add deterministic encoding/scene export golden files under `poml/testdata/diagrams` etc.; assert whitespace/comment preservation toggles match Python (use `ParseStringFast` vs default).
- **CI**: Update `.github/workflows/ci.yml` to run `gofmt -w .`, `/usr/local/go/bin/go test -cover ./...`, and optional `staticcheck` if vendored. Add coverage threshold via `-coverpkg ./...` check or separate tool. Add parity badge once green.
- Exit: CI green with coverage threshold enforced; fixtures give confidence against regressions.

## Phase 4 — Documentation & Release Readiness
- **README**: Add parity snippets (parse/encode, convert formats, builders, multimedia ingestion, tracing). Explicitly state image path containment rules and default size cap. Include code blocks in Go.
- **Versioning**: Remove local `replace` when publishing; bump module version; draft release notes highlighting parity and safety fixes.
- **Examples**: Under `poml/examples/`, add runnable Go samples mirroring Python snippets (prompt build, tool call flow, schema response, image ingestion).
- Exit: Docs aligned, examples runnable, release checklist complete.

## Phase 5 — Polishing & Stretch
- **Renderer polish**: Expand tests for deck.gl/Graphviz with layered diagrams; add options for deterministic ordering and styling coverage where missing.
- **Performance**: Add benchmarks (extend `poml/bench_test.go`) for large docs and converters; profile allocations; keep `Parse*Fast` lean.
- **Observability**: Add opt-in logging/tracing hooks around parse/convert; default off; doc in README.
- Exit: No known perf/UX blockers; optional features documented.

## Execution notes
- Keep ASCII, idiomatic Go, minimal comments. Use `apply_patch` for edits. Run `gofmt` before tests.
- Do not revert user changes. After each phase: `/usr/local/go/bin/go test ./...`; log results in `AI.LOCK.mdx`.

## Parallel workstreams (if multiple agents)
- **Track A (Security/Robustness)**: Phase 1 tasks. Deliver hardened `resolveImagePath`, default size cap, tool validation tests. Coordinate via `AI.LOCK.mdx` with PR pointers.
- **Track B (Parity features)**: Phase 2 tasks (tags, converters, builders, multimedia, tracing). Keep fixtures/tests isolated; note new APIs in `AI.LOCK.mdx`.
- **Track C (Fixtures/CI/Docs)**: Phase 3–4 tasks. Wire CI, port fixtures, update README/examples. Sync with Tracks A/B for API changes via `AI.LOCK.mdx`.
- **Track D (Polish/Perf)**: Phase 5 follow-up after A–C land. Document perf findings in `AI.LOCK.mdx`.
